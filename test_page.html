<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition API Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2 { color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background-color: #45a049; }
        .btn-danger { background-color: #f44336; }
        .btn-danger:hover { background-color: #da190b; }
        .btn-info { background-color: #2196F3; }
        .btn-info:hover { background-color: #0b7dda; }
        .result { margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 4px; max-height: 800px; overflow-y: auto; }
        .person-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; color: #666; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <h1>üé≠ Face Recognition API Test</h1>
    
    <div class="container">
        <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞</h2>
        <form id="addPersonForm">
            <div class="form-group">
                <label for="personName">–ò–º—è:</label>
                <input type="text" id="personName" required>
            </div>
            <div class="form-group">
                <label for="personPhoto">–§–æ—Ç–æ:</label>
                <input type="file" id="personPhoto" accept="image/*" required>
            </div>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
        <div id="addResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="container">
        <h2>üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ª–∏—Ü–æ</h2>
        <div class="form-group">
            <label for="recognizePhoto">–§–æ—Ç–æ:</label>
            <input type="file" id="recognizePhoto" accept="image/*" required>
        </div>
        <button type="button" id="recognizeButton">–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>
        <div id="recognizeResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="container">
        <h2>üë• –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <button onclick="loadPersons()" class="btn-info">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="personsList" class="person-list"></div>
    </div>
    
    <div class="container">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <button onclick="loadStats()" class="btn-info">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <div id="statsContainer" class="stats"></div>
    </div>

    <script>
        console.log("–°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è."); // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        const API_URL = 'http://127.0.0.1:8000';

        document.getElementById('recognizeButton').addEventListener('click', async () => {
            const photoFile = document.getElementById('recognizePhoto').files[0];
            const resultContainer = document.getElementById('recognizeResult');

            if (!photoFile) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.');
                return;
            }

            const formData = new FormData();
            formData.append('photo', photoFile);
            
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<p>‚è≥ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...</p>';
            
            try {
                const response = await fetch(`${API_URL}/api/person/recognize`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}. ${errorText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.');
                }

                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –≤—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                resultContainer.innerHTML = `<h3>${result.message} –ù–∞–π–¥–µ–Ω–æ –ª–∏—Ü: ${result.data.faces_count}</h3>`;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (result.data.processed_image_base64) {
                    const imgElement = document.createElement('img');
                    imgElement.src = `data:image/jpeg;base64,${result.data.processed_image_base64}`;
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.marginTop = '15px';
                    imgElement.style.borderRadius = '4px';
                    resultContainer.appendChild(imgElement);
                }

                // --- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –ª–∏—Ü–µ –∏ –µ–≥–æ –≤–µ–∫—Ç–æ—Ä ---
                if (result.data && result.data.faces_count > 0) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.style.marginTop = '15px';
                    
                    result.data.faces.forEach(face => {
                        const faceDiv = document.createElement('div');
                        faceDiv.style.marginBottom = '10px';
                        
                        const status = face.name !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π" ? "‚úÖ" : "‚ùì";
                        faceDiv.innerHTML = `<strong>${status} ${face.name}</strong>`;
                        
                        if (face.encoding && face.encoding.length > 0) {
                            const vectorText = document.createElement('p');
                            vectorText.style.fontSize = '12px';
                            vectorText.style.wordBreak = 'break-all';
                            vectorText.style.color = '#555';
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 8 —á–∏—Å–µ–ª –≤–µ–∫—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å —ç–∫—Ä–∞–Ω
                            vectorText.innerText = `–í–µ–∫—Ç–æ—Ä –ª–∏—Ü–∞: [${face.encoding.slice(0, 8).join(', ')}, ...]`;
                            faceDiv.appendChild(vectorText);
                        }
                        detailsContainer.appendChild(faceDiv);
                    });
                    
                    resultContainer.appendChild(detailsContainer);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏:', error);
                resultContainer.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        });

        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã  ---
        document.getElementById('addPersonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('personName').value;
            const photoFile = document.getElementById('personPhoto').files[0];
            const formData = new FormData();
            formData.append('name', name);
            formData.append('photo', photoFile);
            const addResult = document.getElementById('addResult');
            addResult.style.display = 'block';
            addResult.innerHTML = '<p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
            try {
                const response = await fetch(`${API_URL}/api/person/add`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    addResult.innerHTML = `<p style="color: green;">‚úÖ ${result.message}</p><p>ID: ${result.data.id}<br>–ò–º—è: ${result.data.name}<br>–ù–∞–π–¥–µ–Ω–æ –ª–∏—Ü: ${result.data.faces_found}</p>`;
                    document.getElementById('addPersonForm').reset();
                    loadPersons();
                    loadStats();
                } else {
                    addResult.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${result.message}</p>`;
                }
            } catch (error) {
                addResult.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        });

        async function loadPersons() {
            try {
                const response = await fetch(`${API_URL}/api/person/list`);
                const result = await response.json();
                const container = document.getElementById('personsList');
                container.innerHTML = '';
                if (result.success && result.data && result.data.persons && result.data.persons.length > 0) {
                    result.data.persons.forEach(person => {
                        const item = document.createElement('div');
                        item.className = 'person-item';
                        item.innerHTML = `<div><strong>#${person.id}</strong> ${person.name} <small>(${person.added_date})</small></div><button class="btn-danger" onclick="deletePerson(${person.id}, '${person.name.replace(/'/g, "\\'")}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞:', error);
                document.getElementById('personsList').innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞: ${error.message}</p>`;
            }
        }

        async function deletePerson(id, name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
            try {
                const response = await fetch(`${API_URL}/api/person/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadPersons();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const result = await response.json();
                const container = document.getElementById('statsContainer');
                container.innerHTML = '';
                if (result.success) {
                    const stats = result.data;
                    container.innerHTML += `<div class="stat-card"><h3>–õ—é–¥–µ–π –≤ –±–∞–∑–µ</h3><div class="value">${stats.total_persons}</div></div>`;
                    container.innerHTML += `<div class="stat-card"><h3>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h3><div class="value">${stats.total_photos}</div></div>`;
                    if (stats.last_added) {
                        container.innerHTML += `<div class="stat-card"><h3>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3><div class="value">${stats.last_added.name}</div><small>${stats.last_added.date}</small></div>`;
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
            }
        }
            document.getElementById('testPostButton').addEventListener('click', async () => {
                const resultContainer = document.getElementById('recognizeResult');
                resultContainer.style.display = 'block';
                resultContainer.innerHTML = '<p>‚è≥ –í—ã–ø–æ–ª–Ω—è—é —Ç–µ—Å—Ç–æ–≤—ã–π POST-–∑–∞–ø—Ä–æ—Å...</p>';
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ POST-–∑–∞–ø—Ä–æ—Å–∞...');

                try {
                    const response = await fetch(`${API_URL}/api/test-post`, {
                        method: 'POST',
                    });

                    if (!response.ok) {
                        throw new Error(`–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —Å –æ—à–∏–±–∫–æ–π: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('–¢–µ—Å—Ç–æ–≤—ã–π POST –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!', data);
                    resultContainer.innerHTML = `<p style="color: green;">‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π POST-–∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!</p>`;

                } catch (error) {
                    console.error('–¢–µ—Å—Ç–æ–≤—ã–π POST-–∑–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è:', error);
                    resultContainer.innerHTML = `<p style="color: red;">‚ùå –¢–µ—Å—Ç–æ–≤—ã–π POST-–∑–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è: ${error.message}</p>`;
                }
            });

        loadPersons();
        loadStats();
    </script>
</body>
</html>