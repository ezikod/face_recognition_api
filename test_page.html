<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition (API Test)</title>
    <style>
       body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            position: relative;
            border: 1px solid #3a3a3a;
        }
        .container.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        h1, h2, h3 {
            color: #f0f0f0;
        }
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-idle {
            background-color: #4CAF50;
            color: white;
        }
        .status-busy {
            background-color: #ff9800;
            color: white;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #b0b0b0;
        }
        label .optional {
            font-weight: normal;
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }
        label .required {
            color: #ff6b6b;
            margin-left: 3px;
        }
        input[type="text"], input[type="email"], input[type="tel"], input[type="file"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="file"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #da190b;
        }
        .btn-info {
            background-color: #2196F3;
        }
        .btn-info:hover {
            background-color: #0b7dda;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #444;
        }
        .error-message {
            color: #ff6b6b;
            padding: 10px;
            background-color: #3a1f1f;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #5a2f2f;
        }
        .warning-message {
            color: #ffa726;
            padding: 10px;
            background-color: #3a2f1a;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #5a4f2a;
        }
        .progress {
            width: 100%;
            height: 4px;
            background-color: #444;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            animation: progress 2s ease-in-out infinite;
        }
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .person-list {
            margin-top: 20px;
        }
        .person-item {
            border: 1px solid #444;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #333;
            overflow: hidden;
        }
        .person-item:hover {
            background-color: #3a3a3a;
            border-color: #555;
        }
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
        }
        .person-header:hover {
            background-color: #3a3a3a;
        }
        .person-info {
            flex-grow: 1;
        }
        .person-info .name {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .person-info .details {
            font-size: 14px;
            color: #999;
        }
        .person-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .expand-icon {
            margin-left: 10px;
            font-size: 12px;
            color: #666;
            transition: transform 0.3s;
        }
        .person-item.expanded .expand-icon {
            transform: rotate(90deg);
        }
        .person-details {
            display: none;
            padding: 0 15px 15px 15px;
            border-top: 1px solid #444;
            background-color: #2a2a2a;
        }
        .person-item.expanded .person-details {
            display: block;
        }
        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #3a3a3a;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: bold;
            color: #999;
            width: 120px;
            flex-shrink: 0;
        }
        .detail-value {
            color: #e0e0e0;
            word-break: break-word;
        }
        .detail-value.empty {
            color: #666;
            font-style: italic;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #444;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #999;
            font-size: 16px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            word-wrap: break-word;
        }
        .key-frames {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .key-frame {
            text-align: center;
            font-size: 12px;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .key-frame img {
            max-width: 100%;
            border-radius: 4px;
            border: 1px solid #555;
        }
        .global-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 200px;
            border: 1px solid #3a3a3a;
        }
        .global-status h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #f0f0f0;
        }
        .global-status .status-text {
            font-size: 12px;
            color: #999;
        }
        .faces-list {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #444;
        }
        .faces-list h4 {
            margin-top: 0;
            color: #4CAF50;
        }
        .face-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #444;
        }
        .face-item:last-child {
            border-bottom: none;
        }
        .face-name {
            color: #e0e0e0;
        }
        .face-stats {
            font-size: 12px;
            color: #999;
        }
        .section-divider {
            margin: 30px 0;
            text-align: center;
            color: #666;
            font-size: 14px;
            position: relative;
        }
        .section-divider::before,
        .section-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #444;
        }
        .section-divider::before {
            left: 0;
        }
        .section-divider::after {
            right: 0;
        }
    </style>
</head>
<body>
    <h1>üåê Database for Face Recognition (API Test)</h1>
    
    <!-- Global Status Indicator -->
    <div class="global-status" id="globalStatus">
        <h4>API Status</h4>
        <div class="status-text" id="statusText">Checking...</div>
        <div class="progress" id="statusProgress" style="display: none;">
            <div class="progress-bar"></div>
        </div>
    </div>
    
    <div class="container" id="addPersonContainer">
        <h2>‚ûï Add Person</h2>
        <span class="status-indicator status-idle" id="addPersonStatus">Ready</span>
        <form id="addPersonForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="personName">First Name:<span class="required">*</span></label>
                    <input type="text" id="personName" required>
                </div>
                <div class="form-group">
                    <label for="personLastName">Last Name:<span class="optional">(optional)</span></label>
                    <input type="text" id="personLastName">
                </div>
            </div>
            
            <div class="form-group">
                <label for="personPhoto">Photo:<span class="required">*</span></label>
                <input type="file" id="personPhoto" accept="image/*" required>
            </div>
            
            <div class="section-divider">Additional Information</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="personWorkplace">Workplace:<span class="optional">(optional)</span></label>
                    <input type="text" id="personWorkplace" placeholder="Company or organization">
                </div>
                <div class="form-group">
                    <label for="personEmail">Email:<span class="optional">(optional)</span></label>
                    <input type="email" id="personEmail" placeholder="email@example.com">
                </div>
            </div>
            
            <div class="form-group">
                <label for="personPhone">Phone:<span class="optional">(optional)</span></label>
                <input type="tel" id="personPhone" placeholder="+1234567890">
            </div>
            
            <button type="submit" id="addPersonBtn">Add Person</button>
            <button type="button" onclick="document.getElementById('addPersonForm').reset()">Clear Form</button>
        </form>
        <div id="addResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="container" id="recognizeContainer">
        <h2>üîç Recognize Face in Photo</h2>
        <span class="status-indicator status-idle" id="recognizeStatus">Ready</span>
        <form id="recognizeForm">
            <div class="form-group">
                <label for="recognizePhoto">Photo:</label>
                <input type="file" id="recognizePhoto" accept="image/*" required>
            </div>
            <button type="submit" id="recognizeBtn">Recognize</button>
        </form>
        <div id="recognizeResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="container" id="videoContainer">
        <h2>üé• Recognize Faces in Video</h2>
        <span class="status-indicator status-idle" id="videoStatus">Ready</span>
        <form id="recognizeVideoForm">
            <div class="form-group">
                <label for="recognizeVideo">Video file:</label>
                <input type="file" id="recognizeVideo" accept="video/*" required>
            </div>
            <div class="form-group">
                <label for="frameInterval">Process every Nth frame:</label>
                <input type="number" id="frameInterval" value="15" min="1" max="60" style="width: 100px;">
            </div>
            <button type="submit" id="videoBtn">Recognize Video</button>
        </form>
        <div id="videoResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="container">
        <h2>üë• Database</h2>
        <button onclick="loadPersons()" class="btn-info">Refresh List</button>
        <button onclick="checkDebugInfo()" class="btn-info">Debug Files</button>
        <button onclick="migrateOldData()" class="btn-info" style="background-color: #ff9800;">Migrate Old Data</button>
        <div id="personsList" class="person-list"></div>
    </div>
    
    <div class="container">
        <h2>üìä Statistics</h2>
        <button onclick="loadStats()" class="btn-info">Refresh Statistics</button>
        <div id="statsContainer" class="stats"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let apiState = 'idle';
        let statusCheckInterval = null;
        
        // API State Management
        class APIStateManager {
            constructor() {
                this.state = 'idle';
                this.currentTask = null;
                this.startStatusPolling();
            }
            
            async checkStatus() {
                try {
                    const response = await fetch(`${API_URL}/api/status`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.state = result.data.state;
                        this.currentTask = result.data.current_task;
                        this.updateUI();
                    }
                } catch (error) {
                    console.error('Status check failed:', error);
                }
            }
            
            updateUI() {
                const globalStatus = document.getElementById('statusText');
                const statusProgress = document.getElementById('statusProgress');
                
                if (this.state === 'idle') {
                    globalStatus.textContent = '‚úÖ Ready';
                    globalStatus.style.color = '#4CAF50';
                    statusProgress.style.display = 'none';
                    this.enableAllForms();
                } else {
                    globalStatus.textContent = `‚è≥ ${this.state}`;
                    globalStatus.style.color = '#ff9800';
                    statusProgress.style.display = 'block';
                    this.disableAllForms();
                    
                    if (this.currentTask) {
                        globalStatus.textContent += ` (${this.currentTask.type})`;
                    }
                }
            }
            
            enableAllForms() {
                document.querySelectorAll('.container').forEach(container => {
                    container.classList.remove('disabled');
                });
                document.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.disabled = false;
                });
            }
            
            disableAllForms() {
                document.querySelectorAll('.container').forEach(container => {
                    if (!container.querySelector('h2')?.textContent.includes('Database') && 
                        !container.querySelector('h2')?.textContent.includes('Statistics')) {
                        container.classList.add('disabled');
                    }
                });
                document.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.disabled = true;
                });
            }
            
            startStatusPolling() {
                this.checkStatus();
                statusCheckInterval = setInterval(() => this.checkStatus(), 10000);
            }
            
            stopStatusPolling() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
            }
        }
        
        const stateManager = new APIStateManager();
        
        // Helper function for handling API errors
        async function handleAPIResponse(response) {
            const result = await response.json();
            
            if (response.status === 503) {
                throw new Error(`System is busy. ${result.message}`);
            }
            
            if (!response.ok) {
                throw new Error(result.message || `HTTP error! status: ${response.status}`);
            }
            
            return result;
        }
        
        // Toggle person details
        function togglePersonDetails(personId) {
            const personItem = document.getElementById(`person-${personId}`);
            if (personItem) {
                personItem.classList.toggle('expanded');
            }
        }
        
        // --- ADD PERSON ---
        document.getElementById('addPersonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('personName').value;
            const lastName = document.getElementById('personLastName').value;
            const workplace = document.getElementById('personWorkplace').value;
            const email = document.getElementById('personEmail').value;
            const phone = document.getElementById('personPhone').value;
            const photoFile = document.getElementById('personPhoto').files[0];
            
            const formData = new FormData();
            formData.append('name', name);
            formData.append('photo', photoFile);
            
            // Add optional fields if they have values
            if (lastName) formData.append('last_name', lastName);
            if (workplace) formData.append('workplace', workplace);
            if (email) formData.append('email', email);
            if (phone) formData.append('phone', phone);
            
            const resultDiv = document.getElementById('addResult');
            const statusIndicator = document.getElementById('addPersonStatus');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>‚è≥ Uploading...</p>';
            statusIndicator.className = 'status-indicator status-busy';
            statusIndicator.textContent = 'Processing';
            
            try {
                const response = await fetch(`${API_URL}/api/person/add`, { 
                    method: 'POST', 
                    body: formData 
                });
                const result = await handleAPIResponse(response);
                
                if (result.success) {
                    resultDiv.innerHTML = `<p style="color: green;">‚úÖ ${result.message}</p>`;
                    document.getElementById('addPersonForm').reset();
                    loadPersons();
                    loadStats();
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${result.message}</p>`;
                }
            } catch (error) {
                if (error.message.includes('busy')) {
                    resultDiv.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
                }
            } finally {
                statusIndicator.className = 'status-indicator status-idle';
                statusIndicator.textContent = 'Ready';
            }
        });
        
        // --- RECOGNIZE PHOTO ---
        document.getElementById('recognizeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const photoFile = document.getElementById('recognizePhoto').files[0];
            const formData = new FormData();
            formData.append('photo', photoFile);
            
            const resultDiv = document.getElementById('recognizeResult');
            const statusIndicator = document.getElementById('recognizeStatus');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>‚è≥ Recognizing...</p>';
            statusIndicator.className = 'status-indicator status-busy';
            statusIndicator.textContent = 'Processing';
            
            try {
                const response = await fetch(`${API_URL}/api/person/recognize`, { 
                    method: 'POST', 
                    body: formData 
                });
                const result = await handleAPIResponse(response);
                
                if (result.success && result.data.faces_count > 0) {
                    let html = `<h3>Results (Found: ${result.data.faces_count}):</h3>`;
                    if (result.data.processed_image_base64) {
                        html += `<div style="margin-bottom: 15px;"><img src="data:image/jpeg;base64,${result.data.processed_image_base64}" style="max-width: 100%; border-radius: 4px;"></div>`;
                    }
                    result.data.faces.forEach(face => {
                        const status = face.name !== "Unknown" ? "‚úÖ" : "‚ùì";
                        const color = face.name !== "Unknown" ? "green" : "red";
                        html += `<div style="margin: 5px 0; padding: 10px; border: 1px solid ${color}; border-radius: 4px;"><strong>${status} ${face.name}</strong></div>`;
                    });
                    resultDiv.innerHTML = html;
                } else if (result.success && result.data.faces_count === 0) {
                    resultDiv.innerHTML = '<p style="color: orange;">‚ö†Ô∏è No faces found in photo</p>';
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${result.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                if (error.message.includes('busy')) {
                    resultDiv.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
                }
            } finally {
                statusIndicator.className = 'status-indicator status-idle';
                statusIndicator.textContent = 'Ready';
            }
        });

        // --- RECOGNIZE VIDEO ---
        document.getElementById('recognizeVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoFile = document.getElementById('recognizeVideo').files[0];
            const frameInterval = document.getElementById('frameInterval').value;
            
            if (!videoFile) { 
                alert('Please select a video file'); 
                return; 
            }

            const formData = new FormData();
            formData.append('video', videoFile);
            formData.append('frame_interval', frameInterval);

            const resultDiv = document.getElementById('videoResult');
            const statusIndicator = document.getElementById('videoStatus');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>‚è≥ Uploading and processing video... This may take some time.</p><div class="progress"><div class="progress-bar"></div></div>';
            statusIndicator.className = 'status-indicator status-busy';
            statusIndicator.textContent = 'Processing Video';

            try {
                const response = await fetch(`${API_URL}/api/video/recognize`, { 
                    method: 'POST', 
                    body: formData 
                });
                const result = await handleAPIResponse(response);

                if (result.success && result.data) {
                    const data = result.data;
                    let html = `<h3>‚úÖ Video Processing Results</h3>`;
                    if (data.summary) {
                        html += `<p>Duration: ${data.summary.duration_seconds.toFixed(1)} sec | Unique faces: ${data.summary.unique_persons}</p>`;
                    }
                    if (data.key_frames && data.key_frames.length > 0) {
                        html += `<h4>Key Frames:</h4><div class="key-frames">`;
                        data.key_frames.forEach(frame => {
                            html += `
                                <div class="key-frame">
                                    <img src="data:image/jpeg;base64,${frame.image_base64}" alt="Frame ${frame.frame_number}">
                                    <span>Time: ${frame.timestamp}s</span>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error-message">‚ùå API Error: ${result.message}</div>`;
                }
            } catch (error) {
                if (error.message.includes('busy')) {
                    resultDiv.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${error.message}<br>Please wait for the current operation to complete.</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
                }
            } finally {
                statusIndicator.className = 'status-indicator status-idle';
                statusIndicator.textContent = 'Ready';
            }
        });
        
        // --- LOAD PERSONS ---
        async function loadPersons() {
            try {
                const response = await fetch(`${API_URL}/api/person/list`);
                const result = await response.json();
                
                const container = document.getElementById('personsList');
                container.innerHTML = '';
                if (result.success && result.data.persons && result.data.persons.length > 0) {
                    result.data.persons.forEach(person => {
                        const fullName = person.last_name ? `${person.name} ${person.last_name}` : person.name;
                        const hasDetails = person.workplace || person.email || person.phone;
                        
                        const item = document.createElement('div');
                        item.className = 'person-item';
                        item.id = `person-${person.id}`;
                        
                        item.innerHTML = `
                            <div class="person-header" onclick="togglePersonDetails(${person.id})">
                                <div class="person-info">
                                    <div class="name">#${person.id} ${fullName}</div>
                                    <div class="details">Added: ${person.added_date}</div>
                                </div>
                                <div class="person-actions">
                                    <button class="btn-info btn-small" onclick="event.stopPropagation(); viewPersonPhoto(${person.id})">View Photo</button>
                                    <button class="btn-danger btn-small" onclick="event.stopPropagation(); deletePerson(${person.id}, '${fullName.replace(/'/g, "\\'")}')">Delete</button>
                                    ${hasDetails ? '<span class="expand-icon">‚ñ∂</span>' : ''}
                                </div>
                            </div>
                            ${hasDetails ? `
                                <div class="person-details">
                                    ${person.workplace ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Workplace:</div>
                                            <div class="detail-value">${person.workplace}</div>
                                        </div>
                                    ` : ''}
                                    ${person.email ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Email:</div>
                                            <div class="detail-value">${person.email}</div>
                                        </div>
                                    ` : ''}
                                    ${person.phone ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Phone:</div>
                                            <div class="detail-value">${person.phone}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Database is empty</p>';
                }
            } catch (error) {
                document.getElementById('personsList').innerHTML = `<p style="color: red;">Error loading list: ${error.message}</p>`;
            }
        }
        
        // --- VIEW PERSON PHOTO ---
        async function viewPersonPhoto(id) {
            const resultDiv = document.getElementById('addResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<p>‚è≥ Loading photo #${id}...</p>`;

            try {
                const response = await fetch(`${API_URL}/api/person/${id}`);
                const result = await response.json();

                if (result.success && result.data && result.data.photo_base64) {
                    const fullName = result.data.last_name ? 
                        `${result.data.name} ${result.data.last_name}` : 
                        result.data.name;
                    
                    let html = `<h3>Photo for: ${fullName}</h3>`;
                    html += `<img src="data:image/jpeg;base64,${result.data.photo_base64}" style="max-width: 100%; border-radius: 4px;">`;
                    
                    // Show additional details if available
                    if (result.data.workplace || result.data.email || result.data.phone) {
                        html += '<div style="margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 4px;">';
                        if (result.data.workplace) {
                            html += `<p><strong>Workplace:</strong> ${result.data.workplace}</p>`;
                        }
                        if (result.data.email) {
                            html += `<p><strong>Email:</strong> ${result.data.email}</p>`;
                        }
                        if (result.data.phone) {
                            html += `<p><strong>Phone:</strong> ${result.data.phone}</p>`;
                        }
                        html += '</div>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else if (result.success && result.data && !result.data.photo_base64) {
                    resultDiv.innerHTML = `<p style="color: orange;">‚ö†Ô∏è Photo file not found for ${result.data.name}</p>`;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${result.message || 'Failed to load person data'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Network error: ${error.message}</p>`;
            }
        }

        // --- DELETE PERSON ---
        async function deletePerson(id, name) {
            if (!confirm(`Delete ${name}?`)) return;
            try {
                const response = await fetch(`${API_URL}/api/person/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadPersons();
                    loadStats();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }
        
        // --- LOAD STATS ---
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const result = await response.json();
                
                const container = document.getElementById('statsContainer');
                container.innerHTML = '';
                if (result.success) {
                    const stats = result.data;
                    
                    const createStatCard = (title, value) => `
                        <div class="stat-card">
                            <h3>${title}</h3>
                            <div class="value">${value}</div>
                        </div>
                    `;

                    container.innerHTML += createStatCard("People in Database", stats.total_persons);
                    container.innerHTML += createStatCard("Photos in Database", stats.total_photos);
                    
                    if (stats.last_added) {
                        container.innerHTML += `
                            <div class="stat-card">
                                <h3>Last Added</h3>
                                <div class="value">${stats.last_added.name}</div>
                                <small>${stats.last_added.date}</small>
                            </div>
                        `;
                    }

                    if (stats.api_state) {
                        const stateColor = stats.api_state === 'idle' ? '#4CAF50' : '#ff9800';
                        container.innerHTML += `
                            <div class="stat-card">
                                <h3>API State</h3>
                                <div class="value" style="color: ${stateColor};">${stats.api_state}</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                document.getElementById('statsContainer').innerHTML = `<p style="color: red;">Error loading statistics: ${error.message}</p>`;
            }
        }
        
        // --- DEBUG CHECK ---
        async function checkDebugInfo() {
            try {
                const response = await fetch(`${API_URL}/api/debug/files`);
                const result = await response.json();
                
                if (result.success) {
                    let message = "üîç Debug Information:\n\n";
                    message += `üìÅ Working Directory: ${result.data.working_directory}\n`;
                    message += `üìÑ CSV File: ${result.data.csv_file_path}\n`;
                    message += `‚úÖ CSV Exists: ${result.data.csv_exists}\n`;
                    message += `üìä CSV Lines: ${result.data.csv_lines || 0}\n`;
                    
                    if (result.data.loaded_in_memory) {
                        message += `\nüíæ Data in Memory:\n`;
                        message += `- Names loaded: ${result.data.loaded_in_memory.known_names}\n`;
                        message += `- Encodings loaded: ${result.data.loaded_in_memory.known_encodings}\n`;
                        message += `- IDs loaded: ${result.data.loaded_in_memory.known_ids}\n`;
                        if (result.data.loaded_in_memory.sample_names.length > 0) {
                            message += `- Sample names: ${result.data.loaded_in_memory.sample_names.join(', ')}\n`;
                        }
                    }
                    
                    if (result.data.old_csv_exists) {
                        message += `\n‚ö†Ô∏è OLD CSV FOUND!\n`;
                        message += `Location: ../persons_data.csv\n`;
                        message += `Lines in old CSV: ${result.data.old_csv_lines}\n`;
                        message += `Lines in current CSV: ${result.data.csv_lines || 0}\n`;
                        
                        if (result.data.old_csv_lines > (result.data.csv_lines || 0)) {
                            message += `\nüö® The old CSV has MORE data than the current one!\n`;
                            message += `The system may have migrated to a new location.\n`;
                            message += `Please restart the API server to copy data from old location.`;
                        }
                    }
                    
                    if (result.data.backup_exists) {
                        message += `\nüíæ Backup file exists with ${result.data.backup_lines} lines`;
                    }
                    
                    console.log('Debug info:', result.data);
                    alert(message);
                } else {
                    alert('Debug check failed: ' + result.message);
                }
            } catch (error) {
                alert('Debug error: ' + error.message);
            }
        }
        
        // --- MIGRATE OLD DATA ---
        async function migrateOldData() {
            if (!confirm('This will copy data from ../persons_data.csv to the current location. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/migrate/old-data`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Migration successful!\n\nCSV copied: ${result.data.csv_copied}\nImages copied: ${result.data.images_copied}\nPersons loaded: ${result.data.persons_loaded}`);
                    loadPersons();
                    loadStats();
                } else {
                    alert(`‚ùå Migration failed: ${result.message}`);
                }
            } catch (error) {
                alert('Migration error: ' + error.message);
            }
        }
        
        // Initial load
        window.onload = () => {
            loadPersons();
            loadStats();
        };
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stateManager.stopStatusPolling();
        });
    </script>
</body>
</html>